name: Build iKoolProxy for OpenWrt 6.12

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses-dev libssl-dev python3 rsync unzip zlib1g-dev file wget

      - name: Clone OpenWrt
        run: |
          git clone https://github.com/openwrt/openwrt.git
          cd openwrt
          git checkout v23.05.2  # Compatible with kernel 6.12

      - name: Update Feed
        working-directory: openwrt
        run: |
          echo "src-git koolproxy https://github.com/ilxp/luci-app-ikoolproxy.git" >> feeds.conf.default
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Configure Build
        working-directory: openwrt
        run: |
          cat >> .config <<EOF
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_DEVICE_generic=y
          CONFIG_KERNEL_VERSION="6.12"
          CONFIG_PACKAGE_luci-app-ikoolproxy=y
          CONFIG_PACKAGE_iptables-mod-nat-extra=y
          CONFIG_PACKAGE_kmod-ipt-extra=y
          CONFIG_PACKAGE_diffutils=y
          CONFIG_PACKAGE_openssl-util=y
          CONFIG_PACKAGE_dnsmasq-full=y
          CONFIG_PACKAGE_ca-bundle=y
          CONFIG_PACKAGE_ca-certificates=y
          CONFIG_PACKAGE_libustream-openssl=y
          CONFIG_PACKAGE_lua-openssl=y
          EOF
          make defconfig

      - name: Download Package Sources
        working-directory: openwrt
        run: make download -j8

      - name: Building packages
        uses: sbwml/openwrt-gh-action-sdk@main
        env:
          ARCH: ${{ matrix.arch }}-openwrt-23.05
          FEEDNAME: packages_ci
          PACKAGES: luci-app-ikoolproxy
          NO_REFRESH_CHECK: true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.arch }}
          path: bin/packages/${{ matrix.arch }}/packages_ci/*.ipk

      - name: Upload packages
        uses: ncipollo/release-action@v1.14.0
        with:
          token: ${{ secrets.REPO_TOKEN }}
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "bin/packages/${{ matrix.arch }}/packages_ci/*.ipk"
